name: Check PR milestone

on:
  # So it cannot be skipped.
  pull_request_target:
    types: [opened, synchronize, milestoned, demilestoned]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # https://stackoverflow.com/questions/69434370/how-can-i-get-the-latest-pr-data-specifically-milestones-when-running-yaml-jobs
  milestone_checker:
    runs-on: ubuntu-latest
    steps:
    - name: Check if milestone check should run
      uses: actions/github-script@v7
      id: check_repo
      with:
        script: |
          const repo_name = context.payload.repository.full_name;
          
          // Only enforce milestone check for the main astropy repository
          if (repo_name !== 'astropy/astropy') {
            core.info(`Milestone check is skipped for fork repository: ${repo_name}`);
            core.setOutput('should_run', 'false');
            return;
          }
          
          core.info(`Running milestone check for main repository: ${repo_name}`);
          core.setOutput('should_run', 'true');
    
    - uses: actions/github-script@v7
      if: steps.check_repo.outputs.should_run == 'true'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data } = await github.request("GET /repos/{owner}/{repo}/pulls/{pr}", {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pr: context.payload.pull_request.number
            });
            if (data.milestone) {
              core.info(`This pull request has a milestone set: ${data.milestone.title}`);
            } else {
              core.setFailed(`A maintainer needs to set the milestone for this pull request.`);
            }
