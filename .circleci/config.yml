version: 2.1

# NOTE: We run these in CircleCI because it has better artifacts support
# and it is possible to publish image diffs as HTML like pytest-mpl in the future.
jobs:

  image-tests-mpl311:
    docker:
      - image: circleci/python:3.9
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
              sudo apt install texlive texlive-latex-extra texlive-fonts-recommended dvipng cm-super
              pip install pip tox --upgrade
      - run:
          name: Run tests
          command: tox -e py39-test-image-mpl311 -- -P visualization --remote-data=astropy --open-files --mpl --mpl-results-path=$PWD/results -W ignore:np.asscalar -W ignore::DeprecationWarning -k "not test_no_numpy_warnings"
      - store_artifacts:
          path: results

  image-tests-mpldev:
    docker:
      - image: circleci/python:3.9
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
              sudo apt install texlive texlive-latex-extra texlive-fonts-recommended dvipng cm-super
              pip install pip tox --upgrade
      - run:
          name: Run tests
          command: tox -e py39-test-image-mpldev -- -P visualization --remote-data=astropy --open-files --mpl-results-path=$PWD/results -W ignore:np.asscalar
      - store_artifacts:
          path: results

  manylinux2014-aarch64:
    parameters:
      production_wheel:
        type: boolean
        default: false

    machine:
      image: ubuntu-2004:202101-01
    resource_class: arm.medium
    environment:
      CIBW_BEFORE_TEST: pytest -p no:warnings --astropy-header -m "not hypothesis" -k "not test_data_out_of_range and not test_wcsapi_extension" --pyargs astropy
      CIBW_TEST_EXTRAS: test
      CIBW_BUILD_VERBOSITY_LINUX: 3
      CIBW_BUILD: "cp38-* cp39-* cp310-*"
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            python3 -m pip install --upgrade pip==21.2.4
            python3 -m pip install cibuildwheel==2.1.2 twine
      - run:
          name: Cibuildwheel
          command: |
            python3 -m cibuildwheel --output-dir wheelhouse
      - store_artifacts:
          path: ./wheelhouse
          destination: astropy
      - when:
          condition:  << parameters.production_wheel>>
          steps:
            - run:
                name: Upload wheels to pypi
                command: |
                  twine upload --skip-existing -u TWINE_USERNAME  -p TWINE_PASSWORD wheelhouse/*

workflows:
  version: 2.1
  tests:
    jobs:
      - image-tests-mpl311
      - image-tests-mpldev
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - manylinux2014-aarch64:
          name: nightly-wheel-AArch64
  build:
    jobs:
      - manylinux2014-aarch64:
          name: development-wheel-AArch64
      - manylinux2014-aarch64:
          name: production-wheel-AArch64
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
          matrix:
            parameters:
              production_wheel: [true]
